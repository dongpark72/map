# 🚀 표준 Docker 배포 가이드 (Standard Deployment Guide - Debian Server)

이 문서는 Debian 서버(100.118.226.70)에서 프로젝트(Audit, DCF, NPL, CB-Valuation 등)가 안정적으로 운영되기 위한 **표준 배포 절차**를 정의합니다.
**⚠️ 중요: 반드시 외장하드 마운트 경로 `/srv/dev-disk-by-uuid-BE7AC6D67AC68A9B/docker/`를 사용해야 합니다.**

---

## 1. 프로젝트별 포트 및 네이밍 규칙 (Master Rule)

각 프로젝트는 고유한 포트 대역과 컨테이너 이름을 사용해야 합니다.

| 프로젝트 | Frontend (External) | Backend (External) | DB (External) | Network Name |
| :--- | :--- | :--- | :--- | :--- |
| **Audit** | **8001** | **8081** | - | `audit-net` |
| **DCF** | **8002** | **8082** | - | `dcf-net` |
| **NPL** | **8003** | **8083** | - | `npl-net` |
| **Gundammap** | **9004** | **9094** | **9746** | `gundam-net` |
| **CB** | **8080** | **8090** | - | `cb-net` |

> **Naming Rule:**
> *   Frontend Container: `[project]-frontend`
> *   Backend Container: `[project]-backend`
> *   DB Container: `[project]-db`

---

## 2. 배포 스크립트 템플릿 (`deploy_debian.bat`)

Debian 서버 배포 시 아래 스크립트 템플릿을 복사하여 사용하세요.
**Server Info:**
*   IP: `100.118.226.70`
*   User: `dongpark72`
*   Pass: `timess9746`
*   **Path: `/srv/dev-disk-by-uuid-BE7AC6D67AC68A9B/docker/%PROJECT_NAME%` (필수)**

```batch
@echo off
rem ========================================================
rem [Debian Server Deployment Script Template]
rem ========================================================
set PROJECT_NAME=[프로젝트명]
set REMOTE_HOST=100.118.226.70
set REMOTE_USER=dongpark72
set REMOTE_PASS=timess9746
rem ⚠️ 중요: 외장하드 절대 경로 사용
set REMOTE_DIR=/srv/dev-disk-by-uuid-BE7AC6D67AC68A9B/docker/%PROJECT_NAME%
set PASSWORD=%REMOTE_PASS%

echo ==========================================
echo Starting Deployment to %REMOTE_HOST%...
echo ==========================================

echo [1/5] Creating remote directory...
echo Connecting to %REMOTE_HOST%...
rem sudo 권한으로 폴더 생성 및 소유권 변경
plink -batch -ssh -pw %PASSWORD% %REMOTE_USER%@%REMOTE_HOST% "echo %PASSWORD% | sudo -S mkdir -p %REMOTE_DIR% && echo %PASSWORD% | sudo -S chown %REMOTE_USER%:%REMOTE_USER% %REMOTE_DIR%"

echo [2/5] Uploading Configs...
pscp -batch -scp -pw %PASSWORD% docker-compose.yml %REMOTE_USER%@%REMOTE_HOST%:%REMOTE_DIR%/docker-compose.yml
rem (추가 파일 업로드: Dockerfile, .env, 등)

echo [3/5] Uploading Source...
pscp -batch -r -scp -pw %PASSWORD% %PROJECT_NAME% %REMOTE_USER%@%REMOTE_HOST%:%REMOTE_DIR%/%PROJECT_NAME%

echo [4/5] Running Docker Compose...
rem docker compose v2 사용 권장
plink -batch -ssh -pw %PASSWORD% %REMOTE_USER%@%REMOTE_HOST% "cd %REMOTE_DIR% && echo %PASSWORD% | sudo -S docker compose down || docker-compose down || true"
plink -batch -ssh -pw %PASSWORD% %REMOTE_USER%@%REMOTE_HOST% "cd %REMOTE_DIR% && echo %PASSWORD% | sudo -S docker compose up -d --build"

echo [5/5] Cleanup...
plink -batch -ssh -pw %PASSWORD% %REMOTE_USER%@%REMOTE_HOST% "echo %PASSWORD% | sudo -S docker image prune -f"

echo Done!
pause
```

---

## 3. Agent 수행 지침 (Instructions)

Agent에게 작업을 지시할 때 다음 문구를 사용하세요:

> "**표준 배포 가이드(.agent-deploy-guide.md)**에 따라 Debian 서버(100.118.226.70)에 배포해줘.
> 특히 **외장하드 경로(/srv/dev-disk-by-uuid-BE7AC6D67AC68A9B/docker/)**를 사용하는지 꼭 확인해."

---

## 4. R2 CDN 적용 (Optional)

프로젝트에 Cloudflare R2 CDN을 적용하려면 다음 가이드를 참고하세요:

### 빠른 적용 (3단계)
자세한 내용은 `.agent-cdn-quick-start.md` 참고

```bash
# Step 1: 자동 설정
python apply_cdn_auto.py

# Step 2: R2에 정적 파일 업로드
python r2_sync_tool.py

# Step 3: 서버 배포 후 검증
python verify_cdn.py
```

### Agent 지시 예시
```
".agent-cdn-quick-start.md 파일을 참고하여 이 프로젝트에 R2 CDN을 적용해줘.

현재 서버 정보:
- 프로젝트: [프로젝트명]
- 서버: [NAS/OMV/Debian]
- R2_SERVER_PREFIX: [서버별 prefix]
- 웹사이트 URL: [URL]

가이드의 3단계를 순서대로 수행하고, 각 단계 완료 후 결과를 보고해줘."
```

### 관련 문서
- `.agent-cdn-quick-start.md` - 빠른 시작 가이드 (Agent용)
- `.agent-cdn-setup-guide.md` - 상세 설정 가이드 (문제 해결 포함)

---
