# ğŸš€ R2 CDN ì ìš© ê°€ì´ë“œ (Agent Instruction)

ì´ ë¬¸ì„œëŠ” Cloudflare R2 CDNì„ Django í”„ë¡œì íŠ¸ì— ì ìš©í•˜ëŠ” **ê²€ì¦ëœ ì ˆì°¨**ì…ë‹ˆë‹¤.
ë‹¤ë¥¸ ì„œë²„(OMV, Debian ë“±)ì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

### 1. R2 ì €ì¥ì†Œ ì„¤ì • í™•ì¸
`.env` íŒŒì¼ì— ë‹¤ìŒ í•­ëª©ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
```env
R2_ACCESS_KEY_ID=your_access_key
R2_SECRET_ACCESS_KEY=your_secret_key
R2_BUCKET_NAME=map-storage
R2_ACCOUNT_ID=your_account_id
R2_ENDPOINT_URL=https://your_account_id.r2.cloudflarestorage.com
R2_SERVER_PREFIX=nas2025  # ë˜ëŠ” omv2025, debian2025 ë“±
R2_CUSTOM_DOMAIN=https://assets.goal-runner.com
```

### 2. í•„ìˆ˜ íŒ¨í‚¤ì§€
`requirements.txt`ì— ë‹¤ìŒì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
```
Django>=4.2
psycopg2-binary>=2.9
gunicorn>=20.1
python-dotenv>=1.0
requests>=2.31
boto3>=1.34.0
django-storages[s3]>=1.14.0
```

---

## ğŸ”§ Step 1: Django ì„¤ì • ì—…ë°ì´íŠ¸

`settings.py`ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€/ìˆ˜ì •:

```python
import os
from dotenv import load_dotenv

load_dotenv()

# Static files configuration
STATIC_URL = "static/"
STATIC_ROOT = os.path.join(BASE_DIR, "staticfiles")
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, "static"),
]

# R2 Storage Configuration
R2_ACCESS_KEY_ID = os.getenv('R2_ACCESS_KEY_ID')
R2_SECRET_ACCESS_KEY = os.getenv('R2_SECRET_ACCESS_KEY')
R2_BUCKET_NAME = os.getenv('R2_BUCKET_NAME')
R2_ENDPOINT_URL = os.getenv('R2_ENDPOINT_URL')
R2_SERVER_PREFIX = os.getenv('R2_SERVER_PREFIX', 'dev')

if R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY:
    # Use R2 for static files
    AWS_ACCESS_KEY_ID = R2_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY = R2_SECRET_ACCESS_KEY
    AWS_STORAGE_BUCKET_NAME = R2_BUCKET_NAME
    AWS_S3_ENDPOINT_URL = R2_ENDPOINT_URL
    AWS_S3_REGION_NAME = 'auto'
    AWS_S3_SIGNATURE_VERSION = 's3v4'
    AWS_QUERYSTRING_AUTH = False
    
    # Static files location in R2
    AWS_LOCATION = f'{R2_SERVER_PREFIX}/static'
    
    # Custom Domain for CDN
    R2_CUSTOM_DOMAIN = os.getenv('R2_CUSTOM_DOMAIN')
    if R2_CUSTOM_DOMAIN:
        # Update STATIC_URL to use CDN
        domain = R2_CUSTOM_DOMAIN.replace('https://', '').replace('http://', '').strip('/')
        AWS_S3_CUSTOM_DOMAIN = domain
        # Set STATIC_URL to CDN domain + location path
        STATIC_URL = f'https://{domain}/{AWS_LOCATION}/'
    else:
        # Fallback to R2 endpoint if no custom domain
        STATIC_URL = f'{R2_ENDPOINT_URL}/{R2_BUCKET_NAME}/{AWS_LOCATION}/'
    
    # IMPORTANT: Use S3Boto3Storage for both (NOT S3StaticStorage)
    STORAGES = {
        "default": {
            "BACKEND": "storages.backends.s3boto3.S3Boto3Storage",
        },
        "staticfiles": {
            "BACKEND": "storages.backends.s3boto3.S3Boto3Storage",
        },
    }
```

**âš ï¸ ì¤‘ìš”**: `S3StaticStorage`ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ `S3Boto3Storage`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”!

---

## ğŸ“ Step 2: í…œí”Œë¦¿ íŒŒì¼ ì—…ë°ì´íŠ¸

ëª¨ë“  HTML í…œí”Œë¦¿ íŒŒì¼ ìƒë‹¨ì— ë‹¤ìŒì„ ì¶”ê°€:

```django
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <!-- CSS íŒŒì¼ -->
    <link rel="stylesheet" href="{% static 'css/your_app.css' %}">
</head>
<body>
    <!-- ë‚´ìš© -->
    
    <!-- JS íŒŒì¼ -->
    <script src="{% static 'js/your_app.js' %}"></script>
</body>
</html>
```

**âŒ ì˜ëª»ëœ ë°©ë²•**: ì¸ë¼ì¸ `<style>` ë˜ëŠ” `<script>` íƒœê·¸ ì‚¬ìš©
**âœ… ì˜¬ë°”ë¥¸ ë°©ë²•**: `{% static %}` íƒœê·¸ë¡œ ì™¸ë¶€ íŒŒì¼ ì°¸ì¡°

---

## ğŸ“¤ Step 3: R2ì— ì •ì  íŒŒì¼ ì—…ë¡œë“œ

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `r2_sync_tool.py` íŒŒì¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
(ì—†ìœ¼ë©´ ì´ ê°€ì´ë“œ í•˜ë‹¨ì˜ ìŠ¤í¬ë¦½íŠ¸ ì°¸ì¡°)

```bash
python r2_sync_tool.py
```

ì—…ë¡œë“œ ê²°ê³¼:
```
[nas2025] R2 uploading: static/css/map_app.css -> nas2025/static/css/map_app.css
[OK] Upload complete!
[nas2025] R2 uploading: static/js/map_app.js -> nas2025/static/js/map_app.js
[OK] Upload complete!
```

---

## ğŸš€ Step 4: ì„œë²„ ë°°í¬

### ë°©ë²• 1: ì „ì²´ ì¬ë°°í¬ (ê¶Œì¥)

```bash
# NAS ì„œë²„ ì˜ˆì‹œ
pscp -batch -scp -r -pw PASSWORD . USER@SERVER:/volume1/docker/PROJECT/

# ì„œë²„ì—ì„œ ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ
plink -batch -ssh -pw PASSWORD USER@SERVER "cd /volume1/docker/PROJECT && \
  echo PASSWORD | sudo -S docker stop PROJECT-backend PROJECT-frontend && \
  echo PASSWORD | sudo -S docker rm PROJECT-backend PROJECT-frontend && \
  echo PASSWORD | sudo -S docker build -f backend.Dockerfile -t PROJECT-backend . && \
  echo PASSWORD | sudo -S docker build -f frontend.Dockerfile -t PROJECT-frontend . && \
  echo PASSWORD | sudo -S docker run -d -p 8084:8000 --name PROJECT-backend --network PROJECT-net --restart unless-stopped PROJECT-backend && \
  echo PASSWORD | sudo -S docker run -d -p 8004:80 --name PROJECT-frontend --network PROJECT-net --restart unless-stopped PROJECT-frontend"
```

### ë°©ë²• 2: ë¹ ë¥¸ ì—…ë°ì´íŠ¸ (ì„¤ì • íŒŒì¼ë§Œ)

```bash
# ì¤‘ìš” íŒŒì¼ë§Œ ì—…ë¡œë“œ
pscp -batch -scp -pw PASSWORD requirements.txt USER@SERVER:/volume1/docker/PROJECT/
pscp -batch -scp -pw PASSWORD gundammap/settings.py USER@SERVER:/volume1/docker/PROJECT/gundammap/
pscp -batch -scp -r -pw PASSWORD templates USER@SERVER:/volume1/docker/PROJECT/

# ë°±ì—”ë“œ ì¬ë¹Œë“œ (requirements.txt ë³€ê²½ ì‹œ í•„ìˆ˜)
plink -batch -ssh -pw PASSWORD USER@SERVER "cd /volume1/docker/PROJECT && \
  echo PASSWORD | sudo -S docker stop PROJECT-backend && \
  echo PASSWORD | sudo -S docker rm PROJECT-backend && \
  echo PASSWORD | sudo -S docker build -f backend.Dockerfile -t PROJECT-backend . && \
  echo PASSWORD | sudo -S docker run -d -p 8084:8000 --name PROJECT-backend --network PROJECT-net --restart unless-stopped PROJECT-backend"
```

---

## âœ… Step 5: ê²€ì¦

### ìë™ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `verify_cdn.py` ìƒì„±:

```python
import requests
import re

def verify_cdn(url, cdn_domain):
    try:
        r = requests.get(url, timeout=10)
        print(f"Status Code: {r.status_code}")
        
        if r.status_code != 200:
            print(f"âŒ Error: HTTP {r.status_code}")
            return False
        
        # CDN ë„ë©”ì¸ í™•ì¸
        has_cdn = cdn_domain in r.text
        print(f"\n{'âœ…' if has_cdn else 'âŒ'} CDN domain ({cdn_domain}) found: {has_cdn}")
        
        # CSS/JS íŒŒì¼ ì°¾ê¸°
        css_matches = re.findall(r'href=["\']([^"\']+\.css[^"\']*)["\']', r.text)
        js_matches = re.findall(r'src=["\']([^"\']+\.js[^"\']*)["\']', r.text)
        
        print(f"\nCSS Files ({len(css_matches)}):")
        for url in css_matches:
            cdn_marker = " [CDN]" if cdn_domain in url else ""
            print(f"  - {url}{cdn_marker}")
        
        print(f"\nJS Files ({len(js_matches)}):")
        for url in js_matches:
            cdn_marker = " [CDN]" if cdn_domain in url else ""
            print(f"  - {url}{cdn_marker}")
        
        # ìš”ì•½
        all_static = css_matches + js_matches
        cdn_count = sum(1 for url in all_static if cdn_domain in url)
        
        print(f"\n{'='*80}")
        print(f"Total static files: {len(all_static)}")
        print(f"Using CDN: {cdn_count}")
        print(f"CDN Status: {'âœ… ENABLED' if cdn_count > 0 else 'âŒ NOT ENABLED'}")
        
        return cdn_count > 0
        
    except Exception as e:
        print(f"âŒ Error: {e}")
        return False

if __name__ == "__main__":
    # ì—¬ê¸°ë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •
    verify_cdn(
        url="https://map.goal-runner.com/portal/",
        cdn_domain="assets.goal-runner.com"
    )
```

ì‹¤í–‰:
```bash
python verify_cdn.py
```

ì˜ˆìƒ ì¶œë ¥:
```
Status Code: 200

âœ… CDN domain (assets.goal-runner.com) found: True

CSS Files (1):
  - https://assets.goal-runner.com/nas2025/static/css/map_app.css [CDN]

JS Files (2):
  - //dapi.kakao.com/v2/maps/sdk.js?appkey=...
  - https://assets.goal-runner.com/nas2025/static/js/map_app.js [CDN]

================================================================================
Total static files: 3
Using CDN: 2
CDN Status: âœ… ENABLED
```

---

## ğŸ› ë¬¸ì œ í•´ê²° (Troubleshooting)

### ë¬¸ì œ 1: "No module named 'storages'" ì—ëŸ¬

**ì›ì¸**: `django-storages`ê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
1. `requirements.txt`ì— `django-storages[s3]>=1.14.0` ì¶”ê°€ í™•ì¸
2. ì„œë²„ì— ì—…ë¡œë“œ
3. ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ (ìºì‹œ ì—†ì´)

```bash
plink -batch -ssh -pw PASSWORD USER@SERVER "cd /volume1/docker/PROJECT && \
  echo PASSWORD | sudo -S docker build --no-cache -f backend.Dockerfile -t PROJECT-backend ."
```

### ë¬¸ì œ 2: "S3StaticStorage not found" ì—ëŸ¬

**ì›ì¸**: ì˜ëª»ëœ í´ë˜ìŠ¤ ì´ë¦„ ì‚¬ìš©

**í•´ê²°**: `settings.py`ì—ì„œ `S3StaticStorage`ë¥¼ `S3Boto3Storage`ë¡œ ë³€ê²½

```python
# âŒ ì˜ëª»ë¨
"BACKEND": "storages.backends.s3boto3.S3StaticStorage"

# âœ… ì˜¬ë°”ë¦„
"BACKEND": "storages.backends.s3boto3.S3Boto3Storage"
```

### ë¬¸ì œ 3: í…œí”Œë¦¿ì— {% static %} íƒœê·¸ê°€ ë Œë”ë§ë˜ì§€ ì•ŠìŒ

**ì›ì¸**: ì„œë²„ì˜ í…œí”Œë¦¿ íŒŒì¼ì´ ì˜¤ë˜ëœ ë²„ì „

**í•´ê²°**:
1. ë¡œì»¬ í…œí”Œë¦¿ íŒŒì¼ í™•ì¸: `{% load static %}` ìˆëŠ”ì§€ í™•ì¸
2. ì„œë²„ì— ì¬ì—…ë¡œë“œ
3. ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ

```bash
pscp -batch -scp -r -pw PASSWORD templates USER@SERVER:/volume1/docker/PROJECT/
```

### ë¬¸ì œ 4: CSS/JSê°€ ì—¬ì „íˆ ì¸ë¼ì¸ìœ¼ë¡œ í¬í•¨ë¨

**ì›ì¸**: í…œí”Œë¦¿ì— `<style>`ì´ë‚˜ `<script>` íƒœê·¸ë¡œ ì§ì ‘ í¬í•¨ë¨

**í•´ê²°**: í…œí”Œë¦¿ íŒŒì¼ì—ì„œ ì¸ë¼ì¸ ì½”ë“œë¥¼ ì œê±°í•˜ê³  `{% static %}` íƒœê·¸ë¡œ êµì²´

```django
<!-- âŒ ì˜ëª»ë¨ -->
<style>
  /* CSS ì½”ë“œ */
</style>

<!-- âœ… ì˜¬ë°”ë¦„ -->
<link rel="stylesheet" href="{% static 'css/app.css' %}">
```

### ë¬¸ì œ 5: 500 ì—ëŸ¬ ë°œìƒ

**ì›ì¸**: Django ì„¤ì • ì˜¤ë¥˜

**í•´ê²°**: ì„œë²„ ë¡œê·¸ í™•ì¸

```bash
plink -batch -ssh -pw PASSWORD USER@SERVER "echo PASSWORD | sudo -S docker logs --tail 50 PROJECT-backend"
```

---

## ğŸ“¦ í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼

### r2_sync_tool.py

```python
import os
import boto3
from botocore.exceptions import NoCredentialsError
from dotenv import load_dotenv

# ENV ë¡œë“œ
load_dotenv()

class R2Uploader:
    def __init__(self):
        self.access_key = os.getenv("R2_ACCESS_KEY_ID")
        self.secret_key = os.getenv("R2_SECRET_ACCESS_KEY")
        self.bucket_name = os.getenv("R2_BUCKET_NAME")
        self.endpoint_url = os.getenv("R2_ENDPOINT_URL")
        self.server_prefix = os.getenv("R2_SERVER_PREFIX", "unknown")
        
        if not all([self.access_key, self.secret_key, self.bucket_name, self.endpoint_url]):
            print(f"[WARNING] [{self.server_prefix}] R2 configuration missing in .env file.")
            self.enabled = False
        else:
            self.enabled = True
            self.s3_client = boto3.client(
                's3',
                endpoint_url=self.endpoint_url,
                aws_access_key_id=self.access_key,
                aws_secret_access_key=self.secret_key,
                region_name='auto'
            )

    def upload_file(self, local_file_path, remote_path=None):
        if not self.enabled:
            return False
            
        filename = os.path.basename(local_file_path)
        if filename == ".env":
            print(f"[SECURITY] Upload blocked: '{local_file_path}' (.env exclusion rule)")
            return False

        if remote_path is None:
            # ì„œë²„ë³„ í´ë” êµ¬ì¡° ì ìš©: assets/ì„œë²„ëª…/íŒŒì¼ëª…
            remote_path = f"assets/{self.server_prefix}/{filename}"

        try:
            print(f"[{self.server_prefix}] R2 uploading: {local_file_path} -> {remote_path}")
            self.s3_client.upload_file(local_file_path, self.bucket_name, remote_path)
            print(f"[OK] Upload complete!")
            return True
        except Exception as e:
            print(f"[ERROR] Upload failed: {e}")
            return False

    def sync_static_files(self):
        print(f"\n--- Static Files Sync ({self.server_prefix}) ---")
        
        static_files = [
            ("static/css/map_app.css", f"{self.server_prefix}/static/css/map_app.css"),
            ("static/js/map_app.js", f"{self.server_prefix}/static/js/map_app.js")
        ]
        
        for local_path, remote_path in static_files:
            if os.path.exists(local_path):
                self.upload_file(local_path, remote_path)
            else:
                print(f"[SKIP] {local_path} (file not found locally)")
                
        print(f"--- Static Sync Complete ---\n")

if __name__ == "__main__":
    uploader = R2Uploader()
    if uploader.enabled:
        uploader.sync_static_files()
    else:
        print("[INFO] Please add R2 credentials to .env file and run again.")
```

---

## ğŸ¯ Agent ì‘ì—… ì§€ì‹œ ì˜ˆì‹œ

ë‹¤ë¥¸ ì„œë²„ì—ì„œ CDNì„ ì ìš©í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì´ ì§€ì‹œí•˜ì„¸ìš”:

```
".agent-cdn-setup-guide.md íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ì´ í”„ë¡œì íŠ¸ì— R2 CDNì„ ì ìš©í•´ì¤˜.

í˜„ì¬ ì„œë²„ ì •ë³´:
- ì„œë²„: OMV (192.168.0.30)
- í”„ë¡œì íŠ¸: audit
- R2_SERVER_PREFIX: omv2025
- í¬íŠ¸: í”„ë¡ íŠ¸ì—”ë“œ 8001, ë°±ì—”ë“œ 8081

ê°€ì´ë“œì˜ ëª¨ë“  ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰í•˜ê³ , ê° ë‹¨ê³„ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ ë³´ê³ í•´ì¤˜.
íŠ¹íˆ Step 5ì˜ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ì„œ CDNì´ ì œëŒ€ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì¤˜."
```

---

## ğŸ“Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë°°í¬ ì „ í™•ì¸ì‚¬í•­:

- [ ] `.env`ì— R2 ì„¤ì • ëª¨ë‘ ì…ë ¥ë¨
- [ ] `requirements.txt`ì— `boto3`, `django-storages[s3]` í¬í•¨
- [ ] `settings.py`ì— R2 ì„¤ì • ì¶”ê°€ (S3Boto3Storage ì‚¬ìš©)
- [ ] í…œí”Œë¦¿ì— `{% load static %}` ì¶”ê°€
- [ ] í…œí”Œë¦¿ì—ì„œ ì¸ë¼ì¸ CSS/JS ì œê±°, `{% static %}` íƒœê·¸ë¡œ êµì²´
- [ ] `r2_sync_tool.py`ë¡œ R2ì— íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ
- [ ] ì„œë²„ì— ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ
- [ ] ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘ ì™„ë£Œ
- [ ] `verify_cdn.py`ë¡œ CDN ì ìš© í™•ì¸ ì™„ë£Œ

---

## ğŸ‰ ì„±ê³µ ê¸°ì¤€

ë‹¤ìŒ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•˜ë©´ ì„±ê³µ:

1. âœ… ì›¹ì‚¬ì´íŠ¸ê°€ 200 OK ì‘ë‹µ
2. âœ… HTMLì— `assets.goal-runner.com` ë„ë©”ì¸ í¬í•¨
3. âœ… CSS íŒŒì¼ì´ `https://assets.goal-runner.com/{SERVER_PREFIX}/static/css/...` í˜•ì‹
4. âœ… JS íŒŒì¼ì´ `https://assets.goal-runner.com/{SERVER_PREFIX}/static/js/...` í˜•ì‹
5. âœ… ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ì •ì  íŒŒì¼ì´ CDNì—ì„œ ë¡œë“œë¨ í™•ì¸

---

**ì‘ì„±ì¼**: 2026-02-16  
**ê²€ì¦ ì™„ë£Œ**: NAS ì„œë²„ (map.goal-runner.com, nas2025)  
**ë‹¤ìŒ ì ìš© ëŒ€ìƒ**: OMV, Debian ì„œë²„
